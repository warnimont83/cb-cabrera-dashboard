{% extends "base.html" %}

{% block content %}
<div class="header">
    <a href="/?season={{ selected_season }}" class="back-link">&larr; Back to CB Cabrera</a>
    <h1>{{ team_info.name }}</h1>
    <p>{{ team_info.club }} - {{ team_info.category }}</p>

    <!-- Season Selector -->
    <div class="season-selector">
        <label for="seasonSelect">Season:</label>
        <select id="seasonSelect" onchange="window.location.href='?season=' + this.value">
            <option value="all" {% if selected_season == 'all' %}selected{% endif %}>All Seasons</option>
            {% for season in available_seasons %}
            <option value="{{ season }}" {% if selected_season == season %}selected{% endif %}>
                {{ season }} {% if season == current_season %}(Current){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="stats-summary">
    <div class="stat-card">
        <h3>{{ match_count }}</h3>
        <p>Matches Played</p>
    </div>
    <div class="stat-card">
        <h3>{{ players|length }}</h3>
        <p>Players</p>
    </div>
    <div class="stat-card">
        <h3>{{ players|sum(attribute='total_points') }}</h3>
        <p>Total Points</p>
    </div>
</div>

<!-- Competition Standings -->
{% if standings %}
<div class="table-container">
    <h2>League Standings - {{ standings.competition_name }}</h2>
    <table class="stats-table">
        <thead>
            <tr>
                <th>Pos</th>
                <th>Team</th>
                <th>MP</th>
                <th>W</th>
                <th>L</th>
                <th>PF</th>
                <th>PA</th>
                <th>Pts</th>
            </tr>
        </thead>
        <tbody>
            {% for team in standings.teams %}
            <tr class="{% if team.team_id == team_id %}highlight-row{% endif %}">
                <td><strong>{{ team.position }}</strong></td>
                <td class="{% if team.team_id == team_id %}team-highlight{% endif %}">
                    {% if team.team_id == team_id %}
                        <strong>{{ team.team_name }}</strong>
                    {% else %}
                        {{ team.team_name }}
                    {% endif %}
                </td>
                <td>{{ team.matches }}</td>
                <td class="text-success">{{ team.wins }}</td>
                <td class="text-danger">{{ team.losses }}</td>
                <td>{{ team.points_for }}</td>
                <td>{{ team.points_against }}</td>
                <td><strong>{{ team.total_points }}</strong></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- Player Statistics -->
<div class="table-container">
    <h2>Player Statistics (Season: {{ selected_season }})</h2>
    <table class="stats-table sortable" id="playerStatsTable">
        <thead>
            <tr>
                <th data-sort="dorsal">#</th>
                <th data-sort="name">Player</th>
                <th data-sort="games">Games</th>
                <th data-sort="total_points">Pts</th>
                <th data-sort="avg_points">PPG</th>
                <th data-sort="total_minutes">Total Min</th>
                <th data-sort="avg_minutes">Avg Min</th>
                {% if has_rebounds %}<th data-sort="avg_rebounds">Reb</th>{% endif %}
                {% if has_assists %}<th data-sort="avg_assists">Ast</th>{% endif %}
                <th data-sort="total_fouls">Fouls</th>
                <th data-sort="total_1p_successful">FT Total</th>
                <th>FT Avg</th>
                <th data-sort="ft_percentage">FT%</th>
                {% if has_fg_stats %}<th data-sort="fg_percentage">FG%</th>{% endif %}
                <th data-sort="total_3p_successful">3PT</th>
                <th data-sort="avg_valoration">Rating</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr>
                <td data-value="{{ player.dorsal }}">{{ player.dorsal }}</td>
                <td data-value="{{ player.name }}">
                    <a href="/player/{{ team_path }}/{{ player.name }}/{{ player.dorsal }}?season={{ selected_season }}" class="player-link">
                        <strong>{{ player.name }}</strong>
                    </a>
                </td>
                <td data-value="{{ player.games }}">{{ player.games }}</td>
                <td data-value="{{ player.total_points }}">{{ player.total_points }}</td>
                <td data-value="{{ player.avg_points }}">{{ player.avg_points }}</td>
                <td data-value="{{ player.total_minutes }}">{{ player.total_minutes }}</td>
                <td data-value="{{ player.avg_minutes }}">{{ player.avg_minutes }}</td>
                {% if has_rebounds %}<td data-value="{{ player.avg_rebounds }}">{{ player.avg_rebounds }}</td>{% endif %}
                {% if has_assists %}<td data-value="{{ player.avg_assists }}">{{ player.avg_assists }}</td>{% endif %}
                <td data-value="{{ player.total_fouls }}">{{ player.total_fouls }}</td>
                <td data-value="{{ player.total_1p_successful }}">{{ player.total_1p_successful }}/{{ player.total_1p_attempted }}</td>
                <td>{{ player.avg_1p_successful|round(1) }}/{{ player.avg_1p_attempted|round(1) }}</td>
                <td data-value="{{ player.ft_percentage }}">{{ player.ft_percentage }}%</td>
                {% if has_fg_stats %}<td data-value="{{ player.fg_percentage }}">{{ player.fg_percentage }}%</td>{% endif %}
                <td data-value="{{ player.total_3p_successful }}">{{ player.total_3p_successful }}/{{ player.total_3p_attempted }}</td>
                <td data-value="{{ player.avg_valoration }}">{{ player.avg_valoration }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Matches List -->
<div class="table-container">
    <h2>Matches ({{ match_count }})</h2>
    <div class="matches-list">
        {% for match in matches %}
        <a href="/match/{{ team_path }}/{{ match.file }}" class="match-card">
            <div class="match-date">{{ match.date }}</div>
            <div class="match-teams">
                <div class="match-team">
                    <span class="team-name">{{ match.local_team }}</span>
                    <span class="team-score">{{ match.local_score }}</span>
                </div>
                <div class="match-vs">vs</div>
                <div class="match-team">
                    <span class="team-name">{{ match.visit_team }}</span>
                    <span class="team-score">{{ match.visit_score }}</span>
                </div>
            </div>
        </a>
        {% endfor %}
    </div>
</div>

<!-- Rival Teams Section -->
{% if rivals %}
<div class="table-container">
    <h2>Rival Teams ({{ rivals|length }})</h2>
    <p class="section-description">Teams this squad has competed against in the selected season</p>
    <table class="stats-table sortable" id="rivalsTable">
        <thead>
            <tr>
                <th data-sort="name">Rival Team</th>
                <th data-sort="matches">Matches</th>
                <th data-sort="wins">W</th>
                <th data-sort="losses">L</th>
                <th>W/L%</th>
                <th data-sort="points_for">Pts For</th>
                <th data-sort="points_against">Pts Against</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rival in rivals %}
            <tr>
                <td data-value="{{ rival.name }}">
                    <strong>{{ rival.name }}</strong>
                </td>
                <td data-value="{{ rival.matches }}">{{ rival.matches }}</td>
                <td data-value="{{ rival.wins }}" class="text-danger">{{ rival.wins }}</td>
                <td data-value="{{ rival.losses }}" class="text-success">{{ rival.losses }}</td>
                <td>
                    {% set win_pct = (rival.wins / rival.matches * 100)|round(1) if rival.matches > 0 else 0 %}
                    <span class="{% if win_pct >= 50 %}text-danger{% else %}text-success{% endif %}">
                        {{ win_pct }}%
                    </span>
                </td>
                <td data-value="{{ rival.points_for }}">{{ rival.points_for }}</td>
                <td data-value="{{ rival.points_against }}">{{ rival.points_against }}</td>
                <td>
                    <a href="/rival/{{ rival.id }}?season={{ selected_season }}&from_team={{ team_id }}" class="btn-rival">
                        Scout Team â†’
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<style>
.section-description {
    color: #666;
    margin-bottom: 1rem;
    font-style: italic;
}

.text-danger {
    color: #e74c3c;
    font-weight: 600;
}

.text-success {
    color: #27ae60;
    font-weight: 600;
}

.btn-rival {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    background: #3498db;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.85rem;
    transition: background 0.3s ease;
}

.btn-rival:hover {
    background: #2980b9;
}

.highlight-row {
    background: #fff3cd !important;
    font-weight: 600;
}

.team-highlight {
    color: #e74c3c;
    font-weight: 700;
}
</style>

<script>
// Table sorting functionality
(function() {
    const table = document.getElementById('playerStatsTable');
    if (!table) return;

    const headers = table.querySelectorAll('th[data-sort]');
    let currentSort = { column: null, ascending: true };

    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.title = 'Click to sort';

        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction if same column
            if (currentSort.column === sortKey) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.ascending = false; // Default to descending for new column
                currentSort.column = sortKey;
            }

            // Remove sort indicators from all headers
            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            // Add sort indicator to current header
            this.classList.add(currentSort.ascending ? 'sort-asc' : 'sort-desc');

            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.querySelector(`td[data-value]`);
                const bCell = b.querySelector(`td[data-value]`);

                // Find the correct cell index
                const headerIndex = Array.from(headers).findIndex(h => h.getAttribute('data-sort') === sortKey);
                const allCellsA = a.querySelectorAll('td[data-value]');
                const allCellsB = b.querySelectorAll('td[data-value]');

                let aValue = allCellsA[headerIndex]?.getAttribute('data-value');
                let bValue = allCellsB[headerIndex]?.getAttribute('data-value');

                // Convert to numbers if possible
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return currentSort.ascending ? aNum - bNum : bNum - aNum;
                }

                // String comparison
                aValue = aValue || '';
                bValue = bValue || '';
                return currentSort.ascending ?
                    aValue.localeCompare(bValue) :
                    bValue.localeCompare(aValue);
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        });
    });
})();

// Rivals table sorting
(function() {
    const table = document.getElementById('rivalsTable');
    if (!table) return;

    const headers = table.querySelectorAll('th[data-sort]');
    let currentSort = { column: null, ascending: true };

    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.title = 'Click to sort';

        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (currentSort.column === sortKey) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.ascending = false;
                currentSort.column = sortKey;
            }

            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            this.classList.add(currentSort.ascending ? 'sort-asc' : 'sort-desc');

            rows.sort((a, b) => {
                const headerIndex = Array.from(headers).findIndex(h => h.getAttribute('data-sort') === sortKey);
                const allCellsA = a.querySelectorAll('td[data-value]');
                const allCellsB = b.querySelectorAll('td[data-value]');

                let aValue = allCellsA[headerIndex]?.getAttribute('data-value');
                let bValue = allCellsB[headerIndex]?.getAttribute('data-value');

                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return currentSort.ascending ? aNum - bNum : bNum - aNum;
                }

                aValue = aValue || '';
                bValue = bValue || '';
                return currentSort.ascending ?
                    aValue.localeCompare(bValue) :
                    bValue.localeCompare(aValue);
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });
})();
</script>
{% endblock %}
