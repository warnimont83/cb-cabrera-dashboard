{% extends "base.html" %}

{% block content %}
<div class="header">
    <a href="/?season={{ selected_season }}" class="back-link">&larr; Back to home</a>
    <h1>Rival Teams Analysis</h1>
    <p>Scout your opponents</p>

    <!-- Season Selector -->
    <div class="season-selector">
        <label for="seasonSelect">Season:</label>
        <select id="seasonSelect" onchange="window.location.href='/rivals?season=' + this.value">
            <option value="all" {% if selected_season == 'all' %}selected{% endif %}>All Seasons</option>
            {% for season in available_seasons %}
            <option value="{{ season }}" {% if selected_season == season %}selected{% endif %}>
                {{ season }} {% if season == current_season %}(Current){% endif %}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="stats-summary">
    <div class="stat-card">
        <h3>{{ total_rivals }}</h3>
        <p>Rival Teams</p>
    </div>
    <div class="stat-card">
        <h3>{{ rivals|sum(attribute='matches_played') }}</h3>
        <p>Matches Played</p>
    </div>
</div>

<!-- Search Box -->
<div class="search-container">
    <input type="text"
           id="rivalSearch"
           class="search-input"
           placeholder="Search for a rival team..."
           autocomplete="off">
</div>

<!-- Rivals Table -->
<div class="table-container">
    <h2>Opponent Teams ({{ selected_season }})</h2>
    <table class="stats-table sortable" id="rivalsTable">
        <thead>
            <tr>
                <th data-sort="name">Team Name</th>
                <th data-sort="matches_played">Matches</th>
                <th data-sort="wins_against_us">W</th>
                <th data-sort="losses_against_us">L</th>
                <th>W/L%</th>
                <th data-sort="avg_points_scored">Avg Pts</th>
                <th>Categories</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rival in rivals %}
            <tr data-rival-name="{{ rival.name|lower }}">
                <td data-value="{{ rival.name }}">
                    <strong>{{ rival.name }}</strong>
                </td>
                <td data-value="{{ rival.matches_played }}">{{ rival.matches_played }}</td>
                <td data-value="{{ rival.wins_against_us }}">{{ rival.wins_against_us }}</td>
                <td data-value="{{ rival.losses_against_us }}">{{ rival.losses_against_us }}</td>
                <td>
                    {% set win_pct = (rival.wins_against_us / rival.matches_played * 100)|round(1) if rival.matches_played > 0 else 0 %}
                    <span class="{% if win_pct >= 50 %}danger-text{% else %}success-text{% endif %}">
                        {{ win_pct }}%
                    </span>
                </td>
                <td data-value="{{ rival.avg_points_scored }}">{{ rival.avg_points_scored }}</td>
                <td>
                    <div class="category-tags-inline">
                        {% for category in rival.categories %}
                        <span class="category-tag-small">{{ category }}</span>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    <a href="/rival/{{ rival.id }}?season={{ selected_season }}" class="btn-small">View Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not rivals %}
<div class="empty-state">
    <h2>No rival teams found</h2>
    <p>No opponents recorded for the selected season</p>
</div>
{% endif %}

<style>
.category-tags-inline {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
}

.category-tag-small {
    background: #f0f0f0;
    padding: 0.15rem 0.5rem;
    border-radius: 8px;
    font-size: 0.75rem;
    color: #666;
}

.btn-small {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    background: #e74c3c;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.85rem;
    transition: background 0.3s ease;
}

.btn-small:hover {
    background: #c0392b;
}

.danger-text {
    color: #e74c3c;
    font-weight: 600;
}

.success-text {
    color: #27ae60;
    font-weight: 600;
}
</style>

<script>
// Rival search functionality
const searchInput = document.getElementById('rivalSearch');
const tableRows = document.querySelectorAll('#rivalsTable tbody tr');

searchInput.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase().trim();

    tableRows.forEach(row => {
        const rivalName = row.getAttribute('data-rival-name');

        if (searchTerm === '' || rivalName.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Table sorting functionality (same as team_new.html)
(function() {
    const table = document.getElementById('rivalsTable');
    if (!table) return;

    const headers = table.querySelectorAll('th[data-sort]');
    let currentSort = { column: null, ascending: true };

    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.title = 'Click to sort';

        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (currentSort.column === sortKey) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.ascending = false;
                currentSort.column = sortKey;
            }

            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });

            this.classList.add(currentSort.ascending ? 'sort-asc' : 'sort-desc');

            rows.sort((a, b) => {
                const headerIndex = Array.from(headers).findIndex(h => h.getAttribute('data-sort') === sortKey);
                const allCellsA = a.querySelectorAll('td[data-value]');
                const allCellsB = b.querySelectorAll('td[data-value]');

                let aValue = allCellsA[headerIndex]?.getAttribute('data-value');
                let bValue = allCellsB[headerIndex]?.getAttribute('data-value');

                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return currentSort.ascending ? aNum - bNum : bNum - aNum;
                }

                aValue = aValue || '';
                bValue = bValue || '';
                return currentSort.ascending ?
                    aValue.localeCompare(bValue) :
                    bValue.localeCompare(aValue);
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });
})();
</script>
{% endblock %}
